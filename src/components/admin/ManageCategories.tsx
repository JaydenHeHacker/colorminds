import { useState } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { supabase } from "@/integrations/supabase/client";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Card } from "@/components/ui/card";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { FolderTree, Plus, Edit, Trash2, Loader2, ChevronRight, ChevronDown, Wand2, Image } from "lucide-react";
import { toast } from "sonner";
import { slugify } from "@/lib/slugify";
import { Badge } from "@/components/ui/badge";

interface Category {
  id: string;
  name: string;
  slug: string;
  description: string | null;
  icon: string | null;
  parent_id: string | null;
  level: number;
  path: string;
  order_position: number;
  created_at: string;
}

export default function ManageCategories() {
  const queryClient = useQueryClient();
  const [editingCategory, setEditingCategory] = useState<Category | null>(null);
  const [deletingCategoryId, setDeletingCategoryId] = useState<string | null>(null);
  const [isCreating, setIsCreating] = useState(false);
  const [expandedCategories, setExpandedCategories] = useState<Set<string>>(new Set());
  const [generatingForCategory, setGeneratingForCategory] = useState<Category | null>(null);

  // Form state
  const [formName, setFormName] = useState("");
  const [formSlug, setFormSlug] = useState("");
  const [formDescription, setFormDescription] = useState("");
  const [formIcon, setFormIcon] = useState("");
  const [formParentId, setFormParentId] = useState<string | null>(null);
  const [formOrderPosition, setFormOrderPosition] = useState("0");

  // Generation form state
  const [theme, setTheme] = useState("");
  const [difficulty, setDifficulty] = useState<"easy" | "medium" | "hard">("medium");
  const [generationType, setGenerationType] = useState<"single" | "series">("single");
  const [seriesLength, setSeriesLength] = useState("5");
  const [generateCount, setGenerateCount] = useState("1");
  const [generatedImages, setGeneratedImages] = useState<string[]>([]);
  const [generatedPagesData, setGeneratedPagesData] = useState<any[]>([]);
  const [isGenerating, setIsGenerating] = useState(false);
  const [isSaving, setIsSaving] = useState(false);

  const { data: categories, isLoading } = useQuery({
    queryKey: ['admin-categories'],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('categories')
        .select('*')
        .order('level', { ascending: true })
        .order('order_position', { ascending: true })
        .order('name', { ascending: true });
      
      if (error) throw error;
      return data as Category[];
    },
  });

  // Query for coloring pages count per category
  const { data: categoryPageCounts } = useQuery({
    queryKey: ['category-page-counts'],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('coloring_pages')
        .select('category_id');
      
      if (error) throw error;
      
      // Count pages per category
      const counts: Record<string, number> = {};
      data.forEach(page => {
        if (page.category_id) {
          counts[page.category_id] = (counts[page.category_id] || 0) + 1;
        }
      });
      return counts;
    },
  });

  const createMutation = useMutation({
    mutationFn: async (newCategory: { 
      name: string;
      slug: string;
      description?: string | null;
      icon?: string | null;
      parent_id?: string | null;
      order_position?: number;
    }) => {
      // path and level will be auto-generated by database trigger
      const dataWithPath = { ...newCategory, path: newCategory.slug };
      const { error } = await supabase
        .from('categories')
        .insert([dataWithPath]);
      
      if (error) throw error;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['admin-categories'] });
      queryClient.invalidateQueries({ queryKey: ['categories'] });
      toast.success("åˆ†ç±»åˆ›å»ºæˆåŠŸï¼");
      resetForm();
      setIsCreating(false);
    },
    onError: (error: Error) => {
      toast.error("åˆ›å»ºå¤±è´¥ï¼š" + error.message);
    },
  });

  const updateMutation = useMutation({
    mutationFn: async ({ id, updates }: { id: string; updates: Partial<Category> }) => {
      const { error } = await supabase
        .from('categories')
        .update(updates)
        .eq('id', id);
      
      if (error) throw error;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['admin-categories'] });
      queryClient.invalidateQueries({ queryKey: ['categories'] });
      toast.success("æ›´æ–°æˆåŠŸï¼");
      setEditingCategory(null);
      resetForm();
    },
    onError: (error: Error) => {
      toast.error("æ›´æ–°å¤±è´¥ï¼š" + error.message);
    },
  });

  const deleteMutation = useMutation({
    mutationFn: async (id: string) => {
      const { error } = await supabase
        .from('categories')
        .delete()
        .eq('id', id);
      
      if (error) throw error;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['admin-categories'] });
      queryClient.invalidateQueries({ queryKey: ['categories'] });
      toast.success("åˆ é™¤æˆåŠŸï¼");
      setDeletingCategoryId(null);
    },
    onError: (error: Error) => {
      toast.error("åˆ é™¤å¤±è´¥ï¼š" + error.message);
    },
  });

  const resetForm = () => {
    setFormName("");
    setFormSlug("");
    setFormDescription("");
    setFormIcon("");
    setFormParentId(null);
    setFormOrderPosition("0");
  };

  const handleOpenCreate = (parentId: string | null = null) => {
    resetForm();
    setFormParentId(parentId);
    setIsCreating(true);
  };

  const handleOpenEdit = (category: Category) => {
    setEditingCategory(category);
    setFormName(category.name);
    setFormSlug(category.slug);
    setFormDescription(category.description || "");
    setFormIcon(category.icon || "");
    setFormParentId(category.parent_id);
    setFormOrderPosition(category.order_position.toString());
  };

  const handleSave = async () => {
    if (!formName || !formSlug) {
      toast.error("è¯·å¡«å†™å¿…å¡«é¡¹");
      return;
    }

    const categoryData = {
      name: formName,
      slug: formSlug,
      description: formDescription || null,
      icon: formIcon || null,
      parent_id: formParentId,
      order_position: parseInt(formOrderPosition),
    };

    if (editingCategory) {
      await updateMutation.mutateAsync({ id: editingCategory.id, updates: categoryData });
    } else {
      await createMutation.mutateAsync(categoryData);
    }
  };

  const handleNameChange = (name: string) => {
    setFormName(name);
    if (!editingCategory) {
      setFormSlug(slugify(name));
    }
  };

  const toggleExpand = (categoryId: string) => {
    const newExpanded = new Set(expandedCategories);
    if (newExpanded.has(categoryId)) {
      newExpanded.delete(categoryId);
    } else {
      newExpanded.add(categoryId);
    }
    setExpandedCategories(newExpanded);
  };

  const handleOpenGenerate = (category: Category) => {
    setGeneratingForCategory(category);
    setTheme("");
    setDifficulty("medium");
    setGenerationType("single");
    setSeriesLength("5");
    setGenerateCount("1");
    setGeneratedImages([]);
    setGeneratedPagesData([]);
  };

  const handleGenerate = async () => {
    if (!theme || !generatingForCategory) {
      toast.error("è¯·è¾“å…¥ä¸»é¢˜");
      return;
    }

    setIsGenerating(true);
    try {
      if (generationType === "series") {
        const length = parseInt(seriesLength);
        const { data, error } = await supabase.functions.invoke('generate-story-series', {
          body: { 
            category: generatingForCategory.name, 
            theme, 
            difficulty, 
            seriesLength: length 
          }
        });

        if (error) throw error;
        
        const imageUrls = data.images.map((img: any) => img.imageUrl);
        setGeneratedImages(imageUrls);
        setGeneratedPagesData(data.images.map((img: any, i: number) => ({
          imageUrl: img.imageUrl,
          sceneDescription: img.sceneDescription,
          order: i
        })));
        toast.success(`æˆåŠŸç”Ÿæˆ ${imageUrls.length} å¼ ç³»åˆ—å›¾ç‰‡ï¼`);
      } else {
        const count = parseInt(generateCount);
        const images: string[] = [];
        const pagesData: any[] = [];
        
        for (let i = 0; i < count; i++) {
          const { data, error } = await supabase.functions.invoke('generate-coloring-page', {
            body: { 
              category: generatingForCategory.name, 
              theme, 
              difficulty 
            }
          });

          if (error) throw error;
          
          images.push(data.imageUrl);
          pagesData.push({
            imageUrl: data.imageUrl,
            suggestedTitle: data.suggestedTitle,
            suggestedDescription: data.suggestedDescription
          });
        }
        
        setGeneratedImages(images);
        setGeneratedPagesData(pagesData);
        toast.success(`æˆåŠŸç”Ÿæˆ ${count} å¼ å›¾ç‰‡ï¼`);
      }
    } catch (error: any) {
      console.error('ç”Ÿæˆé”™è¯¯:', error);
      toast.error("ç”Ÿæˆå¤±è´¥ï¼š" + error.message);
    } finally {
      setIsGenerating(false);
    }
  };

  const handleSaveGenerated = async () => {
    if (!generatingForCategory || generatedImages.length === 0) {
      toast.error("æ²¡æœ‰å¯ä¿å­˜çš„å›¾ç‰‡");
      return;
    }

    setIsSaving(true);
    try {
      let successCount = 0;

      for (let i = 0; i < generatedImages.length; i++) {
        const imageUrl = generatedImages[i];
        const pageData = generatedPagesData[i];
        
        let title, description;
        if (generationType === "series") {
          title = `${theme} - Chapter ${i + 1}`;
          description = pageData?.sceneDescription || null;
        } else {
          title = pageData?.suggestedTitle || theme;
          description = pageData?.suggestedDescription || null;
        }

        const slug = slugify(`${title}-${Date.now()}-${i}`);

        const { error } = await supabase
          .from('coloring_pages')
          .insert({
            title,
            slug,
            description,
            image_url: imageUrl,
            category_id: generatingForCategory.id,
            difficulty,
            is_featured: false,
          });

        if (error) {
          console.error('ä¿å­˜é”™è¯¯:', error);
          toast.error(`ç¬¬ ${i + 1} å¼ å›¾ç‰‡ä¿å­˜å¤±è´¥`);
        } else {
          successCount++;
        }
      }

      if (successCount > 0) {
        toast.success(`æˆåŠŸä¿å­˜ ${successCount} å¼ å›¾ç‰‡ï¼`);
        queryClient.invalidateQueries({ queryKey: ['category-page-counts'] });
        queryClient.invalidateQueries({ queryKey: ['coloring-pages'] });
        setGeneratingForCategory(null);
        setGeneratedImages([]);
        setGeneratedPagesData([]);
      }
    } catch (error: any) {
      console.error('ä¿å­˜é”™è¯¯:', error);
      toast.error("ä¿å­˜å¤±è´¥ï¼š" + error.message);
    } finally {
      setIsSaving(false);
    }
  };

  const buildTree = (cats: Category[]): Category[] => {
    return cats.filter(cat => cat.level === 1);
  };

  const getChildren = (parentId: string): Category[] => {
    return categories?.filter(cat => cat.parent_id === parentId) || [];
  };

  const renderCategory = (category: Category, depth: number = 0) => {
    const children = getChildren(category.id);
    const hasChildren = children.length > 0;
    const isExpanded = expandedCategories.has(category.id);

    return (
      <div key={category.id}>
        <Card className="p-4 mb-2" style={{ marginLeft: `${depth * 24}px` }}>
          <div className="flex items-center justify-between gap-4">
            <div className="flex items-center gap-3 flex-1 min-w-0">
              {hasChildren && (
                <Button
                  variant="ghost"
                  size="icon"
                  className="h-6 w-6 flex-shrink-0"
                  onClick={() => toggleExpand(category.id)}
                >
                  {isExpanded ? (
                    <ChevronDown className="h-4 w-4" />
                  ) : (
                    <ChevronRight className="h-4 w-4" />
                  )}
                </Button>
              )}
              {!hasChildren && <div className="w-6" />}
              
              {category.icon && <span className="text-2xl flex-shrink-0">{category.icon}</span>}
              
              <div className="flex-1 min-w-0">
                <div className="flex items-center gap-2">
                  <h3 className="font-semibold truncate">{category.name}</h3>
                  <Badge variant="secondary" className="gap-1">
                    <Image className="h-3 w-3" />
                    {categoryPageCounts?.[category.id] || 0}
                  </Badge>
                </div>
                <p className="text-xs text-muted-foreground">
                  Level {category.level} â€¢ /{category.path}
                </p>
              </div>
            </div>
            
            <div className="flex gap-2 flex-shrink-0">
              <Button
                variant="default"
                size="sm"
                onClick={() => handleOpenGenerate(category)}
                title="ç”Ÿæˆç´ æ"
                className="gap-1"
              >
                <Wand2 className="h-4 w-4" />
                ç”Ÿæˆç´ æ
              </Button>
              <Button
                variant="ghost"
                size="sm"
                onClick={() => handleOpenCreate(category.id)}
                title="æ·»åŠ å­åˆ†ç±»"
              >
                <Plus className="h-4 w-4 mr-1" />
                å­åˆ†ç±»
              </Button>
              <Button
                variant="ghost"
                size="icon"
                onClick={() => handleOpenEdit(category)}
                title="ç¼–è¾‘"
              >
                <Edit className="h-4 w-4" />
              </Button>
              <Button
                variant="ghost"
                size="icon"
                onClick={() => setDeletingCategoryId(category.id)}
                title="åˆ é™¤"
              >
                <Trash2 className="h-4 w-4" />
              </Button>
            </div>
          </div>
        </Card>

        {hasChildren && isExpanded && (
          <div>
            {children.map(child => renderCategory(child, depth + 1))}
          </div>
        )}
      </div>
    );
  };

  const topLevelCategories = buildTree(categories || []);

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-2xl font-bold flex items-center gap-2">
            <FolderTree className="h-6 w-6" />
            åˆ†ç±»ç®¡ç†
          </h2>
          <p className="text-sm text-muted-foreground mt-1">
            ç®¡ç†å¤šå±‚çº§åˆ†ç±»ç»“æ„ï¼Œæ”¯æŒæ— é™å±‚çº§åµŒå¥—
          </p>
        </div>
        <Button onClick={() => handleOpenCreate()} className="gap-2">
          <Plus className="h-4 w-4" />
          åˆ›å»ºé¡¶çº§åˆ†ç±»
        </Button>
      </div>

      {isLoading ? (
        <div className="flex justify-center py-12">
          <Loader2 className="h-8 w-8 animate-spin" />
        </div>
      ) : topLevelCategories.length > 0 ? (
        <div>
          {topLevelCategories.map(category => renderCategory(category))}
        </div>
      ) : (
        <Card className="p-12">
          <p className="text-center text-muted-foreground">
            è¿˜æ²¡æœ‰åˆ†ç±»ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªåˆ†ç±»
          </p>
        </Card>
      )}

      {/* Create/Edit Dialog */}
      <Dialog 
        open={isCreating || !!editingCategory} 
        onOpenChange={(open) => {
          if (!open) {
            setIsCreating(false);
            setEditingCategory(null);
            resetForm();
          }
        }}
      >
        <DialogContent className="max-w-2xl">
          <DialogHeader>
            <DialogTitle>
              {editingCategory ? "ç¼–è¾‘åˆ†ç±»" : "åˆ›å»ºåˆ†ç±»"}
            </DialogTitle>
            <DialogDescription>
              {formParentId && categories 
                ? `åœ¨ "${categories.find(c => c.id === formParentId)?.name}" ä¸‹åˆ›å»ºå­åˆ†ç±»`
                : "åˆ›å»ºæ–°çš„é¡¶çº§åˆ†ç±»"
              }
            </DialogDescription>
          </DialogHeader>
          
          <div className="space-y-4 py-4">
            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label htmlFor="name">åˆ†ç±»åç§° *</Label>
                <Input
                  id="name"
                  value={formName}
                  onChange={(e) => handleNameChange(e.target.value)}
                  placeholder="ä¾‹å¦‚ï¼šAnimals"
                />
              </div>
              
              <div>
                <Label htmlFor="slug">URLåˆ«å *</Label>
                <Input
                  id="slug"
                  value={formSlug}
                  onChange={(e) => setFormSlug(e.target.value)}
                  placeholder="ä¾‹å¦‚ï¼šanimals"
                />
              </div>
            </div>
            
            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label htmlFor="icon">å›¾æ ‡ Emoji</Label>
                <Input
                  id="icon"
                  value={formIcon}
                  onChange={(e) => setFormIcon(e.target.value)}
                  placeholder="ğŸ¾"
                  maxLength={2}
                />
              </div>
              
              <div>
                <Label htmlFor="order">æ’åºä½ç½®</Label>
                <Input
                  id="order"
                  type="number"
                  value={formOrderPosition}
                  onChange={(e) => setFormOrderPosition(e.target.value)}
                  placeholder="0"
                />
              </div>
            </div>
            
            {editingCategory && (
              <div>
                <Label htmlFor="parent">çˆ¶åˆ†ç±»</Label>
                <Select 
                  value={formParentId || "none"} 
                  onValueChange={(v) => setFormParentId(v === "none" ? null : v)}
                >
                  <SelectTrigger id="parent">
                    <SelectValue placeholder="é€‰æ‹©çˆ¶åˆ†ç±»" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="none">æ— ï¼ˆé¡¶çº§åˆ†ç±»ï¼‰</SelectItem>
                    {categories
                      ?.filter(c => c.id !== editingCategory?.id)
                      .map((cat) => (
                        <SelectItem key={cat.id} value={cat.id}>
                          {"  ".repeat(cat.level - 1)}{cat.icon} {cat.name}
                        </SelectItem>
                      ))}
                  </SelectContent>
                </Select>
              </div>
            )}
            
            <div>
              <Label htmlFor="description">æè¿°</Label>
              <Textarea
                id="description"
                value={formDescription}
                onChange={(e) => setFormDescription(e.target.value)}
                rows={3}
                placeholder="ç®€çŸ­æè¿°è¿™ä¸ªåˆ†ç±»..."
              />
            </div>
          </div>
          
          <DialogFooter>
            <Button 
              variant="outline" 
              onClick={() => {
                setIsCreating(false);
                setEditingCategory(null);
                resetForm();
              }}
            >
              å–æ¶ˆ
            </Button>
            <Button 
              onClick={handleSave} 
              disabled={createMutation.isPending || updateMutation.isPending}
            >
              {(createMutation.isPending || updateMutation.isPending) ? (
                <>
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                  ä¿å­˜ä¸­...
                </>
              ) : (
                "ä¿å­˜"
              )}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Generate Content Dialog */}
      <Dialog 
        open={!!generatingForCategory} 
        onOpenChange={(open) => {
          if (!open) {
            setGeneratingForCategory(null);
            setGeneratedImages([]);
            setGeneratedPagesData([]);
          }
        }}
      >
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-2">
              <Wand2 className="h-5 w-5" />
              ä¸º "{generatingForCategory?.icon} {generatingForCategory?.name}" ç”Ÿæˆç´ æ
            </DialogTitle>
            <DialogDescription>
              ä½¿ç”¨ AI ä¸ºè¯¥åˆ†ç±»ç”Ÿæˆæ¶‚è‰²é¡µç´ æ
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-4 py-4">
            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label htmlFor="gen-theme">ä¸»é¢˜ *</Label>
                <Input
                  id="gen-theme"
                  value={theme}
                  onChange={(e) => setTheme(e.target.value)}
                  placeholder="ä¾‹å¦‚ï¼šå¯çˆ±çš„çŒ«å’ª"
                  disabled={isGenerating || generatedImages.length > 0}
                />
              </div>

              <div>
                <Label htmlFor="gen-difficulty">éš¾åº¦</Label>
                <Select 
                  value={difficulty} 
                  onValueChange={(v: any) => setDifficulty(v)}
                  disabled={isGenerating || generatedImages.length > 0}
                >
                  <SelectTrigger id="gen-difficulty">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="easy">ç®€å•</SelectItem>
                    <SelectItem value="medium">ä¸­ç­‰</SelectItem>
                    <SelectItem value="hard">å›°éš¾</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label htmlFor="gen-type">ç”Ÿæˆç±»å‹</Label>
                <Select 
                  value={generationType} 
                  onValueChange={(v: any) => setGenerationType(v)}
                  disabled={isGenerating || generatedImages.length > 0}
                >
                  <SelectTrigger id="gen-type">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="single">å•å¼ å›¾ç‰‡</SelectItem>
                    <SelectItem value="series">æ•…äº‹ç³»åˆ—</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div>
                <Label htmlFor="gen-count">
                  {generationType === "series" ? "ç³»åˆ—é•¿åº¦" : "ç”Ÿæˆæ•°é‡"}
                </Label>
                <Select 
                  value={generationType === "series" ? seriesLength : generateCount}
                  onValueChange={(v) => generationType === "series" ? setSeriesLength(v) : setGenerateCount(v)}
                  disabled={isGenerating || generatedImages.length > 0}
                >
                  <SelectTrigger id="gen-count">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {generationType === "series" ? (
                      <>
                        <SelectItem value="3">3 å¼ </SelectItem>
                        <SelectItem value="5">5 å¼ </SelectItem>
                        <SelectItem value="8">8 å¼ </SelectItem>
                      </>
                    ) : (
                      <>
                        <SelectItem value="1">1 å¼ </SelectItem>
                        <SelectItem value="2">2 å¼ </SelectItem>
                        <SelectItem value="3">3 å¼ </SelectItem>
                        <SelectItem value="5">5 å¼ </SelectItem>
                      </>
                    )}
                  </SelectContent>
                </Select>
              </div>
            </div>

            {generatedImages.length === 0 ? (
              <Button 
                onClick={handleGenerate} 
                disabled={isGenerating}
                className="w-full gap-2"
              >
                {isGenerating ? (
                  <>
                    <Loader2 className="h-4 w-4 animate-spin" />
                    ç”Ÿæˆä¸­...
                  </>
                ) : (
                  <>
                    <Wand2 className="h-4 w-4" />
                    å¼€å§‹ç”Ÿæˆ
                  </>
                )}
              </Button>
            ) : (
              <div className="space-y-4">
                <div className="flex items-center justify-between">
                  <p className="text-sm font-medium">å·²ç”Ÿæˆ {generatedImages.length} å¼ å›¾ç‰‡</p>
                  <Button
                    variant="ghost"
                    size="sm"
                    onClick={() => {
                      setGeneratedImages([]);
                      setGeneratedPagesData([]);
                    }}
                  >
                    é‡æ–°ç”Ÿæˆ
                  </Button>
                </div>
                
                <div className="grid grid-cols-3 gap-4 max-h-[400px] overflow-y-auto p-2">
                  {generatedImages.map((url, idx) => (
                    <div key={idx} className="relative aspect-square border rounded-lg overflow-hidden bg-muted">
                      <img 
                        src={url} 
                        alt={`ç”Ÿæˆçš„å›¾ç‰‡ ${idx + 1}`}
                        className="w-full h-full object-cover"
                      />
                      <div className="absolute top-2 right-2 bg-background/80 rounded px-2 py-1 text-xs font-medium">
                        #{idx + 1}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>

          <DialogFooter>
            <Button 
              variant="outline" 
              onClick={() => {
                setGeneratingForCategory(null);
                setGeneratedImages([]);
                setGeneratedPagesData([]);
              }}
            >
              å–æ¶ˆ
            </Button>
            {generatedImages.length > 0 && (
              <Button 
                onClick={handleSaveGenerated} 
                disabled={isSaving}
                className="gap-2"
              >
                {isSaving ? (
                  <>
                    <Loader2 className="h-4 w-4 animate-spin" />
                    ä¿å­˜ä¸­...
                  </>
                ) : (
                  <>
                    <Image className="h-4 w-4" />
                    ä¿å­˜åˆ°åˆ†ç±»
                  </>
                )}
              </Button>
            )}
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Delete Confirmation */}
      <AlertDialog 
        open={!!deletingCategoryId} 
        onOpenChange={(open) => !open && setDeletingCategoryId(null)}
      >
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>ç¡®è®¤åˆ é™¤</AlertDialogTitle>
            <AlertDialogDescription>
              æ­¤æ“ä½œå°†åˆ é™¤è¯¥åˆ†ç±»åŠå…¶æ‰€æœ‰å­åˆ†ç±»ã€‚æ‰€æœ‰å…³è”çš„æ¶‚è‰²é¡µå°†å˜ä¸ºæœªåˆ†ç±»çŠ¶æ€ã€‚æ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>å–æ¶ˆ</AlertDialogCancel>
            <AlertDialogAction
              onClick={() => deletingCategoryId && deleteMutation.mutate(deletingCategoryId)}
              className="bg-destructive text-destructive-foreground"
            >
              ç¡®è®¤åˆ é™¤
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
}